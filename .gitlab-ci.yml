# GitLab CI/CD pipeline for wald
#
# Pipeline structure:
#
#   build ──→ test:integration
#     │              │
#     │    test:unit─┤
#     │         │    │
#     │    lint:fmt──┤
#     │         │    │
#     │    lint:clippy
#     │
#     └──→ release (tags only, binaries built locally)
#
# Future: stress testing, benchmarking (see thread 27afdb)

stages:
  - build
  - test
  - release

variables:
  GIT_DEPTH: 1
  RUST_VERSION: "1.93"
  YQ_VERSION: "4.44.3"
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo

# ====================================================================================
# Build Stage
# ====================================================================================

# Build release binary for testing and dev releases
build:
  stage: build
  image: rust:${RUST_VERSION}
  script:
    - cargo build --release
    - ./target/release/wald --version
  artifacts:
    paths:
      - target/release/wald
    expire_in: 1 day
  cache:
    key: cargo-build-${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/registry
      - .cargo/git
      - target
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: never  # Tag builds handled by build:linux-* jobs
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ====================================================================================
# Test Stage
# ====================================================================================

# Unit tests (runs in parallel with build)
test:unit:
  stage: test
  image: rust:${RUST_VERSION}
  script:
    - cargo test --lib -- --nocapture
  cache:
    key: cargo-test-unit-${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/registry
      - .cargo/git
      - target
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Formatting check (runs in parallel with unit tests)
lint:fmt:
  stage: test
  image: rust:${RUST_VERSION}
  script:
    - rustup component add rustfmt
    - cargo fmt --check
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Clippy lint check (runs in parallel with unit tests)
lint:clippy:
  stage: test
  image: rust:${RUST_VERSION}
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings
  cache:
    key: cargo-clippy-${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/registry
      - .cargo/git
      - target
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Integration tests (uses build artifact)
test:integration:
  stage: test
  needs: [build]
  image: debian:bookworm-slim
  before_script:
    - apt-get update
    - apt-get install -y git git-lfs jq wget ca-certificates
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64
    - echo "a2c097180dd884a8d50c956ee16a9cec070f30a7947cf4ebf87d5f36213e9ed7  /usr/local/bin/yq" | sha256sum -c -
    - chmod +x /usr/local/bin/yq
    - git config --global user.name "CI Test"
    - git config --global user.email "ci@wald.test"
    - git config --global pull.rebase true
    - git config --global rebase.autoStash true
  script:
    - ./target/release/wald --version
    - cd test && DEBUG=1 bash run_tests.sh ../target/release/wald
  artifacts:
    when: on_failure
    paths:
      - test/results/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ====================================================================================
# Release Stage (tags only, binaries built locally via release script)
# ====================================================================================

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    description: "Release $CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
