# GitLab CI/CD pipeline for this Rust CLI tool.
#
# CI runs build + tests + linting. Releases are built locally via the unified
# `infrastructure/tools/release` script.

workflow:
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: always

stages:
  - build
  - test

variables:
  GIT_DEPTH: 1
  GIT_FETCH_EXTRA_FLAGS: --tags --force
  RUST_VERSION: "1.93"
  DEBIAN_VERSION: "bookworm"
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  YQ_VERSION: "4.44.3"
  CLAUDE_CODE_SHELL_PREFIX: ""

.rules_common: &rules_common
  - if: $CI_PIPELINE_SOURCE == "push"
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  - if: $CI_PIPELINE_SOURCE == "web"

.cache_common: &cache_common
  paths:
    - .cargo/registry
    - .cargo/git
    - target

.default_rust_job: &default_rust_job
  image: rust:${RUST_VERSION}-slim-${DEBIAN_VERSION}
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq bash git ca-certificates curl jq build-essential pkg-config libssl-dev cmake
    - rustup component add rustfmt
    - |
      if [ -x ./prebuild.sh ]; then
        curl -sL "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64" -o /usr/local/bin/yq
        chmod +x /usr/local/bin/yq
        ./prebuild.sh
      fi

build:
  stage: build
  <<: *default_rust_job
  script:
    - cargo build --locked --release
    - ./target/release/${CI_PROJECT_NAME} --version
  artifacts:
    paths:
      - target/release/${CI_PROJECT_NAME}
    expire_in: 1 day
  cache:
    key: cargo-build-${DEBIAN_VERSION}-${CI_COMMIT_REF_SLUG}
    <<: *cache_common
  rules: *rules_common

test:unit:
  stage: test
  <<: *default_rust_job
  script:
    - cargo test --locked -- --nocapture
  cache:
    key: cargo-test-${DEBIAN_VERSION}-${CI_COMMIT_REF_SLUG}
    <<: *cache_common
  rules: *rules_common

lint:fmt:
  stage: test
  <<: *default_rust_job
  script:
    - cargo fmt --check
  rules: *rules_common

lint:clippy:
  stage: test
  <<: *default_rust_job
  script:
    - rustup component add clippy
    - cargo clippy --locked --all-targets -- -D warnings
  cache:
    key: cargo-clippy-${DEBIAN_VERSION}-${CI_COMMIT_REF_SLUG}
    <<: *cache_common
  rules: *rules_common

test:integration:
  stage: test
  needs: [build]
  image: debian:${DEBIAN_VERSION}-slim
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq bash git git-lfs jq curl ca-certificates gawk
    - curl -sL "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64" -o /usr/local/bin/yq
    - chmod +x /usr/local/bin/yq
    - git config --global user.name "CI"
    - git config --global user.email "ci@example.invalid"
    - git config --global pull.rebase true
    - git config --global rebase.autoStash true
  script:
    - ./target/release/${CI_PROJECT_NAME} --version
    - |
      if [ -x ./test.sh ]; then
        ./test.sh -v
      elif [ -x ./test/run_tests.sh ]; then
        DEBUG=1 ./test/run_tests.sh ./target/release/${CI_PROJECT_NAME}
      elif [ -x ./tests/runner.sh ]; then
        ./tests/runner.sh -v ./target/release/${CI_PROJECT_NAME}
      else
        echo "No integration test runner found (expected: ./test.sh, ./test/run_tests.sh, or ./tests/runner.sh)"
      fi
  artifacts:
    when: on_failure
    paths:
      - test/results/
      - tests/
      - tests/*.log
    expire_in: 1 week
  rules: *rules_common

